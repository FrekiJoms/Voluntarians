<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VOLUNTARIANS</title>
<style>
/* Suggestion  Form Styling */
#suggestionModal select,
#suggestionModal input[type="text"],
#suggestionModal textarea {
  background: #0f1a20;
  color: #e8fbff;
  border: 1px solid rgba(0,210,255,0.12);
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 14px;
  box-shadow: inset 0 2px 12px rgba(0,0,0,0.55);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  transition: box-shadow .14s ease, border-color .12s ease;
  outline: none;
}

#suggestionModal input[type="text"],
#suggestionModal textarea {
  width: 100%;
  resize: vertical;
}

#suggestionModal select:focus,
#suggestionModal input[type="text"]:focus,
#suggestionModal textarea:focus {
  box-shadow: 0 8px 30px rgba(0,210,255,0.06);
  border-color: var(--accent1);
}

/* Add a custom chevron for selects in the modal */
#suggestionModal .row > div {
    position: relative;
}
#suggestionModal .row > div::after {
    content: 'â–¾';
    position: absolute;
    right: 12px;
    top: calc(50% + 8px); /* Adjust for label height */
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--muted);
    font-size: 16px;
}

/* questions style */
/* Glass-style question buttons (default state) */
.ques-btn {
  background: rgba(255,255,255,0.06);        /* translucent glass */
  border: 1px solid rgba(255,255,255,0.12);  /* subtle border */
  color: #e8fbff;
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  backdrop-filter: blur(8px);                /* frosted glass effect */
  box-shadow: 0 4px 14px rgba(0,210,255,0.05);
  transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
}

/* Hover / focus glow */
.ques-btn:hover,
.ques-btn:focus {
  transform: translateY(-2px);
  border-color: rgba(3, 140, 219, 0.541);
  box-shadow: 0 0 0 3px rgba(0,210,255,0.12), 0 10px 30px rgba(0,210,255,0.12);
  outline: none;
}

/* Active press state */
.ques-btn:active {
  transform: translateY(0);
  box-shadow: inset 0 4px 12px rgba(0,0,0,0.25);
}

.questions-wrap {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 24px;
  flex-wrap: wrap;
}
/* close */
:root{
  --logo-size: 130px;
  --box-padding: 7.6px;
  --float-distance: 8px;
  --float-duration: 5s;
  --rotate-angle: 5deg;
  --rotate-duration: 6s;
  --breath-scale: 3.02;
  --breath-duration: 4s;
  --glow-color: rgba(0,210,255,0.16);
  --glow-blur: 20px;
  --easing: cubic-bezier(.2,.9,.2,1);
}
/* outer wrapper: float + rotate + glow */
.float-rotate-wrap{
  display:inline-block;
  padding: var(--box-padding);
  border-radius: 30px;
  background: linear-gradient(135deg,var(--accent1),var(--accent2));
  box-shadow: 0 12px 36px rgba(0,210,255,0.06);
  position: relative;
  transform-origin: center center;
  animation: floatMove var(--float-duration) ease-in-out infinite,
             rotateBox var(--rotate-duration) var(--easing) infinite;
  will-change: transform, box-shadow, filter;
}

/* glow layer */
.float-rotate-wrap::before{
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 22px;
  pointer-events: none;
  filter: blur(var(--glow-blur));
  box-shadow: 0 0 28px var(--glow-color);
  z-index: -1;
  opacity: 0.95;
}

/* inner wrapper: gentle breathing scale */
.float-rotate-inner{
  display:inline-block;
  border-radius: 12px;
  animation: breathe var(--breath-duration) ease-in-out infinite;
  transform-origin: center center;
  will-change: transform;
}

/* the image: apply inverse rotate so the artwork appears stable */
.float-rotate-img{
  display:block;
  width: var(--logo-size);
  height: var(--logo-size);
  border-radius: 12px;
  transform-origin: center center;
  animation: rotateInverse var(--rotate-duration) var(--easing) infinite;
  will-change: transform;
  background: transparent;
}

/* Keyframes */
@keyframes floatMove{
  0%   { transform: translateY(-0.6 * var(--float-distance)); }
  50%  { transform: translateY(0.6 * var(--float-distance)); }
  100% { transform: translateY(-0.6 * var(--float-distance)); }
}
@keyframes rotateBox{
  0%   { transform: rotate(calc(-1 * var(--rotate-angle))); }
  50%  { transform: rotate(calc(var(--rotate-angle))); }
  100% { transform: rotate(calc(-1 * var(--rotate-angle))); }
}
@keyframes rotateInverse{
  0%   { transform: rotate(calc(var(--rotate-angle))); }
  50%  { transform: rotate(calc(-1 * var(--rotate-angle))); }
  100% { transform: rotate(calc(var(--rotate-angle))); }
}
@keyframes breathe{
  0% { transform: scale(1); }
  50%{ transform: scale(var(--breath-scale)); }
 100%{ transform: scale(1); }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .float-rotate-wrap,
  .float-rotate-inner,
  .float-rotate-img{
    animation: none !important;
    transition: none !important;
  }
}

/* small-screen tuning */
@media (max-width:480px){
  :root { --logo-size: 96px; --box-padding:10px; --float-distance:6px; }
  .float-rotate-wrap{ padding:10px; }
}

/* Panel */
.dashboard-panel {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));
  border-radius:12px;
  padding:16px;
}
/* Skeleton loader card */
.card.skeleton {
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.02);
  color: transparent;
  position: relative;
  overflow: hidden;
}
.card.skeleton::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, rgba(255,255,255,0.00) 0%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.00) 100%);
  transform: translateX(-40%);
  animation: shimmer 1s linear infinite;
}
@keyframes shimmer { to { transform: translateX(140%); } }

/* matched text highlight inside card preview */
.msg-preview .match { background: rgba(0,210,255,0.14); color: inherit; padding: 0 4px; border-radius:4px; }

/* remove pill visuals (clean up) */
.projects { display: none !important; }
.pill { display: none !important; }

/* small tweak: ensure Load more button aligns */
#loadMoreBtnWrap { display:flex; justify-content:center; }

/* Cards */
.analytics-cards { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
.dashboard-card {
  background: rgba(10,18,22,0.72);
  border:1px solid rgba(0,210,255,0.06);
  border-radius:12px;
  padding:12px;
  min-width: 100%;
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  display:block;
}
.dashboard-card:focus { outline: 2px solid rgba(0,210,255,0.08); outline-offset:2px; }
.dashboard-card:hover { transform: translateY(-6px); box-shadow: 0 18px 36px rgba(0,210,255,0.06); }
.dashboard-card.placeholder { opacity:0.5; cursor:default; }
.card-body { display:flex; justify-content:space-between; align-items:center; gap:12px; min-width:0; }
.card-heading { font-weight:700; color:#e8fbff; }
.card-sub { font-size:13px; color:var(--muted); margin-top:2px; }
.card-actions { display:flex; align-items:center; gap:8px; }

/* Modal (per-card) */
.card-modal {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,6,10,0.6); z-index:1300;
}
.card-modal[aria-hidden="false"] { display:flex; }
.card-modal-window {
  width: min(1100px, 94vw);
  max-height: 92vh;
  border-radius:12px;
  overflow:hidden; /* clip iframe overflow to avoid scrollbars */
  background: linear-gradient(180deg, rgba(6,12,16,0.98), rgba(8,16,20,0.98));
  border:1px solid rgba(255,255,255,0.02);
  display:flex; flex-direction:column;
}
.card-modal-header { padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center; }
.card-modal-body { padding:0; flex:1 1 auto; min-height:0; display:flex; }
.card-modal-body iframe { width:100%; height:100%; border:0; display:block; overflow:hidden; }

/* Prevent background page scroll while modal open */
body.modal-open { overflow:show; touch-action:none; }

/* Responsive card widths */
@media (max-width:900px) { .dashboard-card { min-width:46%; } .card-modal-window { width:96vw; max-height:94vh; } }
@media (max-width:420px) { .dashboard-card { min-width:100%; } }
  
/* Reset & base */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height:100%; margin:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(120deg,#041428,#07263a,#03304a); background-size: 300% 300%; animation: grad 14s ease infinite; color:#e8fbff; overflow-x: hidden; }
  @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  :root{ --muted:#9fb6c6; --accent1:#00d1ff; --accent2:#1dd3c9; --glass: rgba(255,255,255,0.03); --glass-2: rgba(255,255,255,0.02); --card: rgba(6,14,20,0.75); --max-width:1200px; }

  /* Layout */
  .app { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; }
  .container { width:100%; max-width:var(--max-width); min-height:78vh; background: linear-gradient(180deg,var(--glass-2), rgba(255,255,255,0.04)); border-radius:14px; box-shadow:0 20px 60px rgba(2,8,20,0.75); border:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; overflow:hidden; }

  /* Header */
  .header { display:flex; align-items:center; justify-content:space-between; padding:14px 20px; border-bottom:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); z-index:10; position:relative; }
  .brand { display:flex; gap:14px; align-items:center; }
  .logo-area { width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 10px 30px rgba(0,210,255,0.06); }
  .title{font-weight:700;font-size:15px;color:#e8fbff}
  .subtitle{font-size:12px;color:var(--muted)}

  /* Nav / hamburger */
  .hamburger { display:none; flex-direction:column; gap:5px; cursor:pointer; }
  .hamburger span { width:26px; height:3px; background:var(--accent1); border-radius:2px; }
  .nav-buttons { display:flex; gap:10px; flex-wrap:wrap; }
  .nav-btn { background:transparent; color:var(--accent1); border:1px solid rgba(0,209,255,0.12); padding:8px 14px; border-radius:8px; cursor:pointer; transition:all .18s; font-size:14px; }
  .nav-btn.active, .nav-btn:hover { background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#002; box-shadow:0 6px 18px rgba(0,210,255,0.08); }

  /* Main */
  .main { display:flex; flex-direction:column; gap:18px; padding:22px; overflow:auto; min-height:calc(78vh - 80px); }
  .section { display:none; opacity:0; transition:opacity .28s ease, transform .28s ease; padding:8px 6px; }
  .section.active { display:block; opacity:1; transform: none; }
  .content-wrap { width:100%; max-width:980px; margin:0 auto; }

  /* Form */
  textarea { width:100%; min-height:150px; background:#0f1a20; color:#e8fbff; border:1px solid rgba(0,210,255,0.12); border-radius:12px; padding:14px; font-size:14px; resize:vertical; box-shadow: inset 0 0 8px rgba(0,0,0,0.35); outline: none; }
  textarea:focus { box-shadow: 0 8px 30px rgba(0,210,255,0.06); border-color: rgba(0,210,255,0.28); }
  .row { display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap; }
  .btn { background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#001; border:none; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:700 }
  .btn.ghost { background:transparent; color:var(--accent1); border:1px solid rgba(0,210,255,0.06) }

  .response { margin-top:14px; padding:14px; background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(0,210,255,0.03); word-break:break-word; border-left: 4px solid var(--accent1); display:none; }
  .response.error { border-left-color: #ff4444; background: rgba(40,10,10,0.75); }
  .response.success { border-left-color: #00ff88; background: rgba(6,20,14,0.75); }

  .muted { color:var(--muted); font-size:13px }
/* Filter container and input visual upgrade */
.controls {
  align-items: center;
  gap: 12px;
  display: flex;
  flex-wrap: wrap;
}
/* Styled sort control only */
.sort-wrap { position: relative; display: inline-flex; align-items: center; gap: 8px; }
.sort-select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 10px 38px 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(0,210,255,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  color: #e8fbff;
  font-size: 14px;
  min-width: 160px;
  cursor: pointer;
  transition: box-shadow .12s ease, transform .08s ease, border-color .12s ease;
}
.sort-select:hover { transform: translateY(-1px); }
.sort-select:focus { outline: none; box-shadow: 0 6px 30px rgba(0,210,255,0.06); border-color: var(--accent1); transform: translateY(-1px); }

.sort-decor {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
  font-size: 14px;
  transition: transform .18s ease, color .12s ease;
}
/* Ensure the styled sort select matches the dark theme */
.sort-select,
.sort-select:focus,
.sort-select:active {
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  color: #e8fbff;
  border: 1px solid rgba(0,210,255,0.08);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  box-shadow: inset 0 2px 12px rgba(0,0,0,0.55);
  padding-right: 38px; /* keep space for decorative chevron */
}

/* Attempt to style the native popup list where browsers allow it */
.sort-select option {
  background: #071723;
  color: #e8fbff;
}

/* IE/Edge value styling */
.sort-select::-ms-value {
  color: #e8fbff;
  background: transparent;
}

/* iOS / Safari fallback: darken the focused control to reduce white flash */
@supports (-webkit-touch-callout: none) {
  .sort-select:focus {
    background: linear-gradient(180deg, rgba(3,18,24,0.96), rgba(10,24,30,0.96));
  }
}

/* Keep decorative chevron readable */
.sort-decor {
  color: var(--muted);
}

/* Hover / focus visual affordance */
.sort-select:hover { transform: translateY(-1px); }
.sort-select:focus { outline: none; box-shadow: 0 6px 30px rgba(0,210,255,0.06); border-color: var(--accent1); transform: translateY(-1px); }

/* Small-screen tweak */
@media (max-width:600px) {
  .sort-select { min-width: 140px; padding-right: 38px; font-size: 14px; }
}

.sort-wrap:hover .sort-decor,
.sort-select:focus + .sort-decor {
  color: var(--accent1);
  transform: translateY(-50%) scale(1.04);
}

@media (max-width:600px) {
  .sort-select { min-width: 140px; padding-right: 38px; font-size: 14px; }
}

/* Search input (filter) */
.search {
  padding: 10px 14px;
  min-width: 220px;
  max-width: 420px;
  border-radius: 12px;
  border: 1px solid rgba(0,210,255,0.08);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  color: #e8fbff;
  font-size: 14px;
  transition: box-shadow .16s ease, transform .12s ease, border-color .12s ease;
  box-shadow: 0 4px 18px rgba(2,8,20,0.45) inset;
}

/* Placeholder color */
.search::placeholder { color: rgba(255,255,255,0.45); }

/* Focus / hover states for better affordance */
.search:hover {
  border-color: rgba(55, 78, 77, 0.14);
  transform: translateY(-1px);
}
.search:focus {
  outline: none;
  border-color: var(--accent1);
  box-shadow: 0 6px 30px rgba(0,210,255,0.08), 0 0 0 4px rgba(0,210,255,0.06);
  transform: translateY(-2px);
}

/* Small clear button inside the search input (requires small HTML addition) */
.search-wrap { position: relative; display: inline-block; }
.search-clear {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.6);
  padding: 6px;
  border-radius: 8px;
  cursor: pointer;
  transition: background .12s ease, color .12s ease, transform .08s ease;
}
.search-clear:hover { background: rgba(255,255,255,0.02); color: #fff; transform: translateY(-50%) translateX(-2px); }

/* Sort select styling to match the filter */
.controls select {
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(0,210,255,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  color: #e8fbff;
  font-size: 14px;
  transition: box-shadow .12s ease, transform .12s ease;
}
.controls select:hover { transform: translateY(-1px); }
.controls select:focus { box-shadow: 0 6px 30px rgba(0,210,255,0.06); outline: none; border-color: var(--accent1); }

/* Small responsive tweak */
@media (max-width:600px) {
  .search { min-width: 100%; max-width: none; }
  .controls { flex-direction: column; align-items: stretch; gap: 10px; }
}
/* suggestion â€” visual polish (no HTML/JS changes) */
#suggestion .content-wrap { padding-top: 6px; }

/* Selects (main + sub) */
#suggestion select {
  -webkit-appearance: none;
  appearance: none;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(0,210,255,0.08);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  color: #e8fbff;
  font-size: 14px;
  margin-right: 8px;
  min-width: 160px;
  transition: box-shadow .14s ease, transform .08s ease, border-color .12s ease;
  outline: none;
}
#suggestion select:hover { transform: translateY(-1px); }
#suggestion select:focus { box-shadow: 0 8px 30px rgba(0,210,255,0.06); border-color: var(--accent1); }

/* Container for the selects and buttons inside suggestion (keeps original structure) */
#suggestion .content-wrap > select + select { margin-top: 8px; } /* small vertical gap if stacked */
#suggestion .content-wrap { display:block; }

/* suggestion list container */
#suggestion #suggestion-container {
  margin-top: 14px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
  align-items: start;
}

/* Idea card visuals (applies to any elements you render inside #suggestion-container) */
#suggestion .idea-card,
#suggestion .card,
#suggestion #suggestion-container > div {
  background: rgba(10,18,22,0.72);
  border: 1px solid rgba(0,210,255,0.06);
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 8px 26px rgba(0,210,255,0.02);
  transition: transform .12s cubic-bezier(.2,.9,.2,1), box-shadow .12s ease, background .12s ease;
}

/* Slight lift + stronger shadow on hover/focus to indicate interactivity */
#suggestion #suggestion-container > div:hover,
#suggestion #suggestion-container > div:focus-within {
  transform: translateY(-4px);
  box-shadow: 0 18px 44px rgba(0,210,255,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
}

/* Title inside each idea card (if you render a title element or plain text) */
#suggestion #suggestion-container .title,
#suggestion #suggestion-container .idea-title,
#suggestion #suggestion-container h3,
#suggestion #suggestion-container .card .title {
  font-weight:700;
  font-size:15px;
  margin:0 0 6px 0;
  color: #e8fbff;
}

/* Meta / small text */
#suggestion #suggestion-container .meta,
#suggestion #suggestion-container .muted {
  color: var(--muted);
  font-size:13px;
  margin: 0;
}

/* Buttons inside idea items â€” reuse your .btn and .btn.ghost but tighten spacing */
#suggestion #suggestion-container .btn,
#suggestion #suggestion-container .btn.ghost {
  padding: 8px 12px;
  font-size:13px;
  border-radius:10px;
}
#suggestion #suggestion-container .btn.ghost { background: transparent; border: 1px solid rgba(0,210,255,0.06); color: var(--accent1); }
#suggestion #suggestion-container .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(0,210,255,0.04); }

/* Fine-tune copy feedback small state */
#suggestion #suggestion-container .btn.copied {
  background: linear-gradient(90deg,var(--accent2),var(--accent1));
  color: #001;
}
/* Make native selects match the dark theme and avoid white dropdowns */
#suggestion select,
#suggestion select:focus,
#suggestion select:active {
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  color: #e8fbff;
  border: 1px solid rgba(0,210,255,0.08);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

/* Ensure the selected option in the closed control is styled (value area) */
#suggestion select::-ms-value { /* IE/Edge */
  color: #e8fbff;
  background: transparent;
}

/* Try to style the native popup list background where browsers allow it */
#suggestion select option {
  background: #071723; /* dark popup background */
  color: #e8fbff;      /* option text color */
}

/* WebKit: attempt to reduce white flash on open by forcing system dropdown styling */
#suggestion select::-webkit-calendar-picker-indicator,
#suggestion select::-webkit-contacts-auto-fill-button {
  display: none !important;
}

/* Add a custom inner shadow so the control looks cohesive with the app */
#suggestion select {
  box-shadow: inset 0 2px 12px rgba(0,0,0,0.55);
}

/* Keep padding for the value area so the chevron (if present) doesn't overlap */
#suggestion select { padding-right: 14px; }

/* On mobile Safari / iOS the OS still governs the full-screen picker.
   Use a fallback darker background when the control is focused to reduce visual jank. */
@supports (-webkit-touch-callout: none) {
  #suggestion select:focus {
    background: linear-gradient(180deg, rgba(3,18,24,0.96), rgba(10,24,30,0.96));
  }
}

/* Optional small tweak: if you added .sort-decor or other children next to selects,
   ensure they remain readable on dark backgrounds */
#suggestion .sort-decor,
#suggestion .select-decor {
  color: var(--muted);
}

/* Responsive adjustments */
@media (max-width:900px) {
  #suggestion #suggestion-container { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  #suggestion select { min-width: 140px; font-size:14px; }
}

@media (max-width:600px) {
  #suggestion .content-wrap > select { display:block; width:100%; margin-right:0; margin-bottom:8px; }
  #suggestion #suggestion-container { grid-template-columns: 1fr; gap:10px; }
  #suggestion #suggestion-container > div { padding:10px; border-radius:10px; }
}

  /* Controls & cards */
  .controls{ display:flex; gap:10px; margin-bottom:16px; align-items:center; flex-wrap:wrap }
  .search { padding:8px 10px; background:#0f1a20; border-radius:10px; border:1px solid rgba(0,210,255,0.06); color:#e8fbff; min-width:200px; }
  .card { background:rgba(10,18,22,0.72); border:1px solid rgba(0,210,255,0.06); border-radius:12px; padding:12px; margin-bottom:12px; box-shadow:0 8px 28px rgba(0,210,255,0.02); max-width:100%; overflow-x:hidden; word-break:break-word; }
  .card .meta { color:var(--muted); font-size:13px; margin-bottom:8px }
  .projects { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap }
  .pill { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(0,210,255,0.06); font-size:13px; cursor:pointer }

  /* Multi-line preview clamp + safe wrapping */
  .msg-preview {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    --webkit-line-clamp: 4;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.25em;
    max-height: calc(1.25em * 4);
    white-space: normal;
    word-break: break-word;
    overflow-wrap: anywhere;
    hyphens: auto;
    box-sizing: border-box;
    background: transparent;
  }

@keyframes modalPopIn {
  0% { transform: translateY(14px) scale(0.96); opacity: 0; }
  60% { transform: translateY(-6px) scale(1.02); opacity: 1; }
  100% { transform: translateY(0) scale(1); opacity: 1; }
}
@keyframes modalPopOut {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(8px) scale(0.96); opacity: 0; }
}
/* ensure both modal container types animate when .closing is applied */
.card-modal.closing .card-modal-window,
.modal-backdrop.closing .modal-window,
.card-modal.closing .card-modal-window,
.modal-backdrop.closing .card-modal-window {
  animation: modalPopOut 260ms cubic-bezier(.3,.7,.25,1) both;
}
/* open animation when aria-hidden false or .active */
.card-modal[aria-hidden="false"] .card-modal-window,
.modal-backdrop.active .modal-window {
  animation: modalPopIn 320ms cubic-bezier(.2,.9,.22,1) both;
}

/* When modal is closed (aria-hidden="true" or .active removed),
   the browser will use the normal state. For smoother exit on browsers
   that remove the element immediately, we also provide a short outgoing animation
   when aria-hidden is set to true via a class toggle (optional). */
/* If you later add JS to add a `.closing` class before hiding, this rule will animate out: */
.card-modal.closing .card-modal-window,
.modal-backdrop.closing .modal-window {
  animation: modalPopOut 220ms cubic-bezier(.3,.7,.25,1) both;
}

  /* Modal */
  .modal-backdrop { position: fixed; inset: 0; width:100%; height:100%; display:none; background: rgba(0,0,0,0.55); backdrop-filter: blur(8px); z-index:2500; align-items:center; justify-content:center; padding:22px; }
  .modal-backdrop.active { display:flex; }
  .modal-window { width:100%; max-width:980px; max-height:88vh; border-radius:14px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 30px 80px rgba(0,0,0,0.6), 0 2px 12px rgba(0,210,255,0.04); border: 1px solid rgba(255,255,255,0.04); transform: translateY(8px) scale(.96); opacity:0; transition: transform .28s cubic-bezier(.2,.9,.22,1), opacity .22s ease; display:flex; flex-direction:column; }
  .modal-backdrop.active .modal-window { transform: translateY(0) scale(1); opacity:1; }
  .modal-header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; }
  .modal-header h3 { margin:0; font-size:18px; }
  .modal-body { overflow-y:auto; overflow-x:hidden; padding-right:6px; max-height:72vh; word-break:break-word; }

  .spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,0.08); border-top-color:var(--accent1); animation:spin .9s linear infinite; display:inline-block; vertical-align:middle }
  @keyframes spin{ to { transform:rotate(360deg) } }

  /* Mobile adjustments */
  @media (max-width:900px) { .container { border-radius:10px; } .main { padding:16px; } .modal-window { padding:14px; max-width: 96%; max-height:92vh; } }
  @media (max-width:600px) {
    .hamburger { display:flex; }
    .header .nav-buttons { position:absolute; top:100%; left:0; width:100%; background:rgba(10,18,22,0.95); justify-content:center; gap:10px; padding:12px; border-bottom:1px solid rgba(255,255,255,0.06); display:none; z-index:100; flex-direction:row; }
    .header .nav-buttons.active { display:flex; animation:navFadeIn .25s ease; }
    @keyframes navFadeIn { from{opacity:0; transform:translateY(-8px);} to{opacity:1; transform:translateY(0);} }
    .header .nav-btn { padding:10px 14px; font-size:14px; border-radius:8px; }
    .msg-preview { --webkit-line-clamp: 3; max-height: calc(1.25em * 3); }
    .card { padding:10px; font-size:14px; }
    .projects { flex-direction:column; gap:8px; }
  }
  
</style>
</head>
<body>
  <div class="app">
    <div class="container" id="appContainer" aria-live="polite">

      <!-- START SCREEN -->
      <div id="homeScreen" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:28px;text-align:center;z-index:2200;background:rgba(0,0,0,0.44);backdrop-filter: blur(14px);">
        <div style="width:120px;height:140px;border-radius:20px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;box-shadow:0 12px 40px rgba(0,210,255,0.12)">
            <div class="float-rotate-wrap">
                <img style="height:130px;width:130px" src="https://i.postimg.cc/F19sM0qH/volunlogo.png" alt="Voluntarians Logo" class="float-rotate-wrap"></div>
            </div>
            <h1 style="margin:0;font-size:24px;font-weight:800">VOLUNTARIANS HUB</h1>
        <p style="max-width:520px;margin:0;color:var(--muted)">A hub that connects problems to solutions. The rise of an era of Volunteers, <strong>the Voluntarians.</strong></p>
        <button id="startBtn" style="margin-top:6px;padding:12px 26px;border-radius:12px;border:none;font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001;cursor:pointer;box-shadow:0 10px 30px rgba(0,210,255,0.06)">Start</button>
        <div class="muted" style="margin-top:6px">Submit concerns â€¢ Generate project ideas â€¢ Inspire collaborative teamwork</div>
      </div>

      <!-- Header -->
      <div class="header" role="banner">
        <div class="brand" role="img" aria-label="Voluntarians Hub">
          <div class="logo-area">
            <img src="https://i.postimg.cc/F19sM0qH/volunlogo.png" alt="Logo" style="width:60px;height:60px;border-radius:8px;"></div>
          <div>
            <div class="title">THE VOLUNTARIANS' HUB</div>
            <div class="subtitle">Community Platform v0.2.5</div>
          </div>
        </div>
        <div class="hamburger" id="hamburger" aria-controls="primaryNav" aria-expanded="false" role="button" tabindex="0">
          <span></span><span></span><span></span>
        </div>
        <div id="primaryNav" class="nav-buttons" role="navigation" aria-label="Main navigation">
          <button class="nav-btn active" data-target="submit" onclick="handleNav(event)">Submit</button>
          <button class="nav-btn" data-target="recommended" onclick="handleNav(event)">Messages</button>
          <button class="nav-btn" data-target="suggestion" onclick="handleNav(event)">Suggestions</button>
          <button class="nav-btn" data-target="idea" onclick="handleNav(event)">Ideas</button>
          <button class="nav-btn" data-target="dashboardPage" onclick="handleNav(event)">Analytics</button>
        </div>
      </div>

        <!-- Submit -->
      <!-- Main -->
      <div class="main" role="main">
        <section id="submit" class="section active">
          <div class="content-wrap">
<h2>SUBMIT A CONCERN</h2>
<label for="concern-category" class="muted" style="display:block;margin-bottom:8px">Category</label>
<select id="concern-category" aria-label="Concern category" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(0,210,255,0.06);background:#071723;color:#e8fbff;margin-bottom:12px;">
  <option value="">Choose category</option>
  <option value="TMF">TMF</option>
  <option value="EXE">EXE</option>
  <option value="Kaizenset">Kaizenset</option>
  <option value="Other">Others</option>
</select>
<textarea id="concern-text" aria-label="Your concern" placeholder="Describe the issue or concern in detail..." maxlength="1000" aria-describedby="charCount"></textarea>

<div class="row" style="margin-top:8px; align-items:center;">
  <div id="charCount" class="muted" style="flex:1">0 / 1000</div>
  <div style="display:flex;gap:8px;">
    <button id="submitBtn" class="btn" onclick="openSubmitConfirm()">Send Report</button>
    <button id="clearBtn" class="btn ghost" onclick="clearInput()">Reset Form</button>
  </div>
</div>
<div id="submitLoader" style="display:none;margin-top:10px"><span class="spinner" aria-hidden="true"></span> Submitting your concern...</div>
<div id="response" class="response" aria-live="polite"></div>
    <div id="questions" class="questions-wrap">
        <button class="ques-btn" data-key="made" onclick="openQuestionModal('made')">Voluntarians Hub Origin</button>
        <button class="ques-btn" data-key="overview" onclick="openQuestionModal('overview')">Overview</button>
        <button class="ques-btn" data-key="use" onclick="openQuestionModal('use')">How to use?</button>
    </div>
        </div>
        </section>

        <!-- Recommended -->
        <section id="recommended" class="section">
          <div class="content-wrap">
            <h2>MESSAGE LOG</h2>
            <p class="muted">Logs for all the concerns and issues submitted</p>
            <div class="controls">
             <div class="sort-wrap" style="margin-bottom:12px">
                <select id="sortOrder" class="sort-select" onchange="sortCards()" aria-label="Sort messages">
                  <option value="newest">Newest First</option>
                  <option value="oldest">Oldest First</option>
                </select>
              <div class="sort-decor" aria-hidden="true">â–¾</div>
            </div>
        <div class="search-wrap">
              <input id="search" class="search" placeholder="Search recommended..." oninput="filterCards()" aria-label="Search recommended" />
              <button class="search-clear" onclick="qs('#search').value=''; filterCards();" aria-label="Clear search">âœ•</button>
          </div>
              <div style="display:flex; gap:8px;">
                <button class="btn ghost" onclick="fetchRecommendations()">Refresh</button>
              </div>
            </div>
            <div id="cards-container" aria-live="polite"></div>
            <div id="recLoader" style="display:none;margin-top:10px"><span class="spinner"></span> Loading...</div>
          </div>
        </section>

    <!-- Ideas -->
        <section id="idea" class="section">
          <div class="content-wrap">
            <h2>COMMUNITY IDEAS</h2>
            <p class="muted">Browse suggestions submitted by the community.</p>
            <div class="controls" style="margin-bottom:12px;">
                <button class="btn ghost" onclick="fetchIdeas()">Refresh</button>
            </div>
            <div id="ideas-container" class="analytics-cards" aria-live="polite"></div>
            <div id="ideasLoader" style="display:none;margin-top:10px"><span class="spinner"></span> Loading ideas...</div>
          </div>
        </section>

        <!-- suggestion -->
        <section id="suggestion" class="section">
          <div class="content-wrap">
            <h2>SUGGESTIVE IDEAS</h2>
            <p class="muted">Choose a category to submit suggested ideas</p>
            <select id="main-category" onchange="updateSubcategories()" aria-label="Main category">
              <option value="">Choose Main Category</option>
              <option value="TMF">TMF</option>
              <option value="EXE">EXE</option>
              <option value="Kaizenset">Kaizenset</option>
              <option value="Other">Others</option>
            </select>
                <select id="sub-category" onchange="handleSubcategoryChange(event)" aria-label="Subcategory">
              <option value="">Choose Subcategory</option>
            </select>
            <div id="suggestion-container" class="suggestion" style="margin-top:14px"></div>
          </div>
        </section>

<!-- Dashboard Page -->
<section id="dashboardPage" class="section">
  <div class="content-wrap" style="margin-top:8px">
  <div class="dashboard-panel">
    <div class="panel-head">
      <div>
        <div class="panel-title">ðŸ“Š Voluntarians' Dashboard</div>
        <div class="muted panel-sub">View analytics, activity trends, and live charts based on the data gathered.</div>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Tip: nandito naka lagay kung ano yung mostly requested.</div>
    <div class="analytics-cards" style="margin-top:12px">
      <!-- Main Analytics card -->
      <div class="dashboard-card" data-key="main">
        <div class="card-body">
          <div>
            <div class="card-heading">ðŸ“Š Main Analytics</div>
            <div class="card-sub muted">All categories</div>
          </div>
          <div class="card-actions">
            <button class="btn" data-key="main">View</button>
          </div>
        </div>
      </div>

      <!-- EXE -->
      <div class="dashboard-card" data-key="exe">
        <div class="card-body">
          <div>
            <div class="card-heading">ðŸ“Š EXE Analytics</div>
            <div class="card-sub muted">EXE subcategories</div>
          </div>
          <div class="card-actions">
            <button class="btn" data-key="exe">View</button>
          </div>
        </div>
      </div>

      <!-- TMF -->
      <div class="dashboard-card" data-key="tmf">
        <div class="card-body">
          <div>
            <div class="card-heading">ðŸ“Š TMF Analytics</div>
            <div class="card-sub muted">TMF subcategories</div>
          </div>
          <div class="card-actions">
            <button class="btn" data-key="tmf">View</button>
          </div>
        </div>
      </div>

      <!-- Kaizenset -->
      <div class="dashboard-card" data-key="kaizenset">
        <div class="card-body">
          <div>
            <div class="card-heading">ðŸ“Š Kaizenset Analytics</div>
            <div class="card-sub muted">Kaizenset</div>
          </div>
          <div class="card-actions">
            <button class="btn" data-key="kaizenset">View</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</section>

<!-- Idea Details Modal -->
<div id="ideaDetailsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-window" role="document" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>ðŸ’¡ Idea Details</h3>
      <button class="btn ghost" style="font-weight:bold;font-size:18px;line-height:1;" onclick="closeIdeaDetailsModal()">âœ•</button>
    </div>
    <div class="modal-body" id="ideaDetailsModalBody"></div>
  </div>
</div>

<!-- questions modals -->
 <!-- Modal for questions -->
<div id="questionModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" onclick="closeQuestionModal()">
  <div class="modal-window" role="document" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="questionModalTitle">Info</h3>
      <button class="btn ghost" onclick="closeQuestionModal()">âœ•</button>
    </div>
    <div class="modal-body" id="questionModalBody" style="white-space:pre-wrap"></div>
  </div>
</div>

<!-- Submit confirmation modal -->
<div id="submitConfirmBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" onclick="closeSubmitConfirm()">
  <div class="modal-window" role="document" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirm Submission</h3>
      <button class="btn ghost" style="font-weight:bold;font-size:18px;line-height:1;" onclick="closeSubmitConfirm()">âœ•</button>
    </div>
    <div class="modal-body" id="submitConfirmBody" style="padding:12px;">
      <div class="muted" style="margin-bottom:8px">Please confirm the concern you are about to submit:</div>
      <div style="margin-bottom:10px"><strong id="confirmCategory">Category</strong></div>
      <pre id="confirmMessage" style="white-space:pre-wrap;margin:6px 0;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.02);max-height:240px;overflow:auto;"></pre>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="confirmCancelBtn" class="btn ghost" onclick="closeSubmitConfirm()">Cancel</button>
        <button id="confirmSendBtn" class="btn">Confirm & Send</button>
      </div>
    </div>
  </div>
</div>

  <!-- Message Modal -->
  <div id="messageModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" onclick="closeMessageModal()">
    <div class="modal-window" role="document" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>ðŸ“© Message Details</h3>
        <button class="btn ghost" style="font-weight:bold;font-size:18px;line-height:1;" onclick="closeMessageModal()">âœ•</button>
      </div>
      <div class="modal-body" id="messageModalBody"></div>
    </div>
  </div>

<!-- Modal (frosted) -->
  <div id="modal-main" class="card-modal" role="dialog" aria-modal="true" aria-hidden="true" onclick="backdropClick(event,'main')">
    <div class="card-modal-window" role="document" onclick="event.stopPropagation()">
      <header class="card-modal-header">
        <h3>ðŸ“Š Voluntarians Dashboard</h3>
      <div><button class="btn ghost" onclick="closeCardModal('main')">Close</button></div>
      </header>
      <main class="card-modal-body">
        <iframe id="iframe-main" src="" frameborder="0" loading="lazy"></iframe>
      </main>
    </div>
  </div>

<!-- EXE modal -->
<div id="modal-exe" class="card-modal" aria-hidden="true" role="dialog" aria-modal="true" onclick="modalBackdropClick(event,'exe')">
  <div class="card-modal-window" role="document" onclick="event.stopPropagation()">
    <header class="card-modal-header">
      <h3>EXE Analytics</h3>
      <div><button class="btn ghost" onclick="closeCardModal('exe')">Close</button></div>
    </header>
    <main class="card-modal-body">
      <iframe id="iframe-exe" src="" frameborder="0" loading="lazy"></iframe>
    </main>
  </div>
</div>

<!-- TMF modal -->
<div id="modal-tmf" class="card-modal" aria-hidden="true" role="dialog" aria-modal="true" onclick="modalBackdropClick(event,'tmf')">
  <div class="card-modal-window" role="document" onclick="event.stopPropagation()">
    <header class="card-modal-header">
      <h3>TMF Analytics</h3>
      <div><button class="btn ghost" onclick="closeCardModal('tmf')">Close</button></div>
    </header>
    <main class="card-modal-body">
      <iframe id="iframe-tmf" src="about:blank" frameborder="0" loading="lazy"></iframe>
    </main>
  </div>
</div>

<!-- Kaizenset modal -->
<div id="modal-kaizenset" class="card-modal" aria-hidden="true" role="dialog" aria-modal="true" onclick="modalBackdropClick(event,'kaizenset')">
  <div class="card-modal-window" role="document" onclick="event.stopPropagation()">
    <header class="card-modal-header">
      <h3>Kaizenset Analytics</h3>
      <div><button class="btn ghost" onclick="closeCardModal('kaizenset')">Close</button></div>
    </header>
    <main class="card-modal-body">
      <iframe id="iframe-kaizenset" src="about:blank" frameborder="0" loading="lazy"></iframe>
    </main>
  </div>
</div>

<!-- Suggestion Submission Modal -->
<div id="suggestionModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-window" role="document" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Submit a Suggestion</h3>
      <button class="btn ghost" style="font-weight:bold;font-size:18px;line-height:1;" onclick="closeSuggestionModal()">âœ•</button>
    </div>
    <div class="modal-body" id="suggestionModalBody" style="padding:12px;">
      <div id="suggestionResponse" class="response" aria-live="polite"></div>
      <form id="suggestionForm">
        <div class="row" style="margin-bottom:12px;">
            <div style="flex:1">
                <label for="suggestion-main-category" class="muted">Main Category</label>
                <select id="suggestion-main-category" style="width:100%; margin-top:4px;"></select>
            </div>
            <div style="flex:1">
                <label for="suggestion-sub-category" class="muted">Sub-Category</label>
                <select id="suggestion-sub-category" style="width:100%; margin-top:4px;"></select>
            </div>
        </div>
        <label for="suggestion-title" class="muted">Title</label>
        <input type="text" id="suggestion-title" placeholder="A brief title for your suggestion" style="min-height:auto; margin-top:4px; margin-bottom:12px;" required>

        <label for="suggestion-details" class="muted">Details</label>
        <textarea id="suggestion-details" placeholder="Describe your suggestion in detail..." required style="margin-top:4px; margin-bottom:12px;"></textarea>

        <label for="suggestion-author" class="muted">Author</label>
        <input type="text" id="suggestion-author" placeholder="Your name (optional)" style="min-height:auto; margin-top:4px;">
      </form>
      <div id="suggestionLoader" style="display:none;margin-top:10px"><span class="spinner" aria-hidden="true"></span> Submitting...</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" onclick="closeSuggestionModal()">Cancel</button>
        <button id="suggestionSendBtn" class="btn">Send Suggestion</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const DEPLOYED_ID = 'AKfycbwwNGtFQYj2nvGBRC2eDXzknVX9FtlCIj7NOXc4N1zvxuvXFs_lTAAesmipL0TbsqwG';
// NOTE: SECRET TOKEN removed from client. Keep any verification or tokens server-side.

/*
  Replace the URLs below with your published Google Sheets pubchart URLs
  or with WRAPPER_URL + '?src=' + encodeURIComponent(pubchartURL) if you host the responsive wrapper.
*/


const CARD_CHARTS = {
  main:      'https://docs.google.com/spreadsheets/d/e/2PACX-1vTzGMwUdbf0twIVwDY1iCqoN1_v1D4T9g6D3qmiRKoAo4W9PxY51vDMUyvI2yyzfFDeG3WrxXba5hV_/pubchart?oid=1006276544&format=interactive',
  exe:       'https://docs.google.com/spreadsheets/d/e/2PACX-1vTzGMwUdbf0twIVwDY1iCqoN1_v1D4T9g6D3qmiRKoAo4W9PxY51vDMUyvI2yyzfFDeG3WrxXba5hV_/pubchart?oid=1177720902&format=interactive',
  tmf:       'https://docs.google.com/spreadsheets/d/e/YOUR_TMF_PUBURL/pubchart?oid=ZZZ&format=interactive',
  kaizenset: 'https://docs.google.com/spreadsheets/d/e/YOUR_KAIZEN_PUBURL/pubchart?oid=AAA&format=interactive'
};
// questions function
function openQuestionModal(key){
  const modal = qs('#questionModal');
  const title = qs('#questionModalTitle');
  const body = qs('#questionModalBody');
  let content = '';
  let heading = '';
// infos
  switch(key){
    case 'made':
      heading = 'Voluntarians Hub Origin';
      content = 'An architected blueprint with a vision crafted by Kaiser combined by the determined spirit of Josh to bring this dream to life, makes the VOLUNTARIANS Hub turn into reality.';
      break;
    case 'overview':
      heading = 'Overview';
      content = 'Voluntarians Hub connect people, those who see problems and those who solve them, forging an era of volunteers.';
      break;
    case 'use':
      heading = 'How to use?';
      content = 'DAKO KOG OTEN';
      break;
    default:
      heading = 'Info';
      content = 'No content available.';
    }

  title.textContent = heading;
  body.textContent = content;
  modal.classList.add('active');
  modal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}

function closeQuestionModal(){
  const modal = qs('#questionModal');
  if (!modal) return;
  modal.classList.remove('active');
  modal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeQuestionModal(); });

}

// open per-card modal
function openCardModal(key){
  const modal = document.getElementById('modal-' + key);
  const iframe = document.getElementById('iframe-' + key);
  if(!modal || !iframe) return;
  // load chart (swap for wrapper if necessary)
  iframe.src = CARD_CHARTS[key] || CARD_CHARTS.main;
  modal.setAttribute('aria-hidden','false');
  document.documentElement.classList.add('modal-open');
  document.body.classList.add('modal-open');
  // focus close for accessibility
  setTimeout(()=> {
    const btn = modal.querySelector('button[aria-label="Close chart"], button');
    if(btn) btn.focus();
  }, 50);
}

// close per-card modal
function closeCardModal(key){
  const modal = document.getElementById('modal-' + key);
  const iframe = document.getElementById('iframe-' + key);

  // pick a sensible focus target; try dashboard view button or main nav
  const returnFocus = qs(`.dashboard-card[data-key="${key}"]`) || qs('#primaryNav button[data-target="recommended"]') || qs('#submitBtn');

  // animate close
  animateCloseModal(modal, returnFocus);

  // clear iframe after animation ends (safe guard: wait 380ms)
  setTimeout(() => {
    if (iframe) iframe.src = 'about:blank';
  }, 380);
}

// backdrop click handler (only close when clicking backdrop)
function modalBackdropClick(e, key){
  if(e.target && e.currentTarget && e.target === e.currentTarget) closeCardModal(key);
}

// wire click handlers: card body and view buttons
document.addEventListener('click', function(e){
  const viewBtn = e.target.closest('.view-btn');
  if(viewBtn){
    const key = viewBtn.getAttribute('data-key');
    if(key) openCardModal(key);
    e.stopPropagation();
    return;
  }

  const card = e.target.closest('.dashboard-card');
  if(card && !card.classList.contains('placeholder')){
    const key = card.getAttribute('data-key');
    if(key) openCardModal(key);
  }
});

// keyboard: allow Enter/Space to open focused card
document.addEventListener('keydown', function(e){
  if((e.key === 'Enter' || e.key === ' ') && document.activeElement && document.activeElement.classList.contains('dashboard-card')){
    e.preventDefault();
    const key = document.activeElement.getAttribute('data-key');
    if(key) openCardModal(key);
  }

  // ESC closes any open modal
  if(e.key === 'Escape'){
    ['main','exe','tmf','kaizenset'].forEach(k=>{
      const m = document.getElementById('modal-' + k);
      if(m && m.getAttribute('aria-hidden') === 'false') closeCardModal(k);
    });
  }
});

// Keep your existing message modal close function if present
window.closeMessageModal = window.closeMessageModal || function(){
  const b = document.getElementById('messageModalBackdrop');
  if(b) b.setAttribute('aria-hidden','true');
};

/* ---------- HELPERS ---------- */
function qs(s){ return document.querySelector(s); }
function qsa(s){ return Array.from(document.querySelectorAll(s)); }
function fmtDate(src){ if(!src) return ''; const d=new Date(src); return isNaN(d)?src:d.toLocaleString(); }
function safeText(t){ return (t===undefined||t===null)?'':String(t); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeForInline(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,' '); }

/* ---------- START SCREEN ---------- */
const homeScreen = qs('#homeScreen'), startBtn = qs('#startBtn');
startBtn.addEventListener('click', () => {
  homeScreen.style.transition = "opacity .8s ease, transform .6s ease";
  homeScreen.style.opacity = "0"; homeScreen.style.transform = "scale(1.02)";
  setTimeout(()=> homeScreen.style.display = 'none', 550);
  setTimeout(()=> showSection('submit'), 580);
});

/* ---------- NAV ---------- */
function handleNav(e){
  const btn = e.currentTarget;
  qsa('.nav-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const target = btn.getAttribute('data-target');
  showSection(target);
  if (target === 'idea') {
    fetchIdeas(); // <-- ADD THIS LINE
  }
}
function showSection(id){
  qsa('.section').forEach(s=>s.classList.remove('active'));
  const el = qs('#'+id);
  if(el) el.classList.add('active');
  qs('.main').scrollTop = 0;
}
/* ---------- Modal close with pop-out animation helper ---------- */
/*
  Usage:
    // to close a modal element (backdrop or card-modal)
    animateCloseModal(modalElement);

  Behavior:
    - Adds a `.closing` class so CSS pop-out will play (you already have modalPopOut keyframe).
    - Waits for animationend (or 240ms fallback) then sets aria-hidden="true", removes .active/.closing and clears body modal-open.
    - Keeps focus management: moves focus back to a sensible element when possible.
*/
function animateCloseModal(modalEl, returnFocusEl) {
  if (!modalEl) { console.warn('animateCloseModal no modalEl'); return; }
  if (modalEl.classList.contains('closing')) return;
  modalEl.classList.add('closing');
  // remove active to let CSS pick "closing" animation visually
  modalEl.classList.remove('active');
  const cleanup = () => {
    modalEl.classList.remove('closing');
    try { modalEl.setAttribute('aria-hidden','true'); } catch(e){}
    // remove page modal flags if no other modal open
    const otherOpen = document.querySelector('.modal-backdrop.active, .card-modal[aria-hidden="false"]');
    if (!otherOpen) {
      document.documentElement.classList.remove('modal-open');
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
    }
    if (returnFocusEl && typeof returnFocusEl.focus === 'function') {
      try { returnFocusEl.focus({preventScroll:true}); } catch(e) {}
    }
  };

  const onAnim = (ev) => {
    if (ev && ev.animationName && ev.animationName.toLowerCase().includes('modalpopout')) {
      modalEl.removeEventListener('animationend', onAnim);
      cleanup();
    }
  };
  modalEl.addEventListener('animationend', onAnim);

  // fallback timeout
  setTimeout(() => {
    if (modalEl.classList.contains('closing')) cleanup();
  }, 420);
}

/* ---------- MODALS ---------- */
const modalBackdrop = qs('#modalBackdrop');
function openModal(){
  modalBackdrop.classList.add('active');
  modalBackdrop.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  const frame = qs('#dashboardFrame');
  if(frame && frame.src === 'about:blank') {
    frame.src = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTzGMwUdbf0twIVwDY1iCqoN1_v1D4T9g6D3qmiRKoAo4W9PxY51vDMUyvI2yyzfFDeG3WrxXba5hV_/pubchart?oid=1006276544&format=interactive';
  }
}
function closeModal() {
  const modalEl = modalBackdrop;
  // optional: return focus to a primary control
  const returnFocus = qs('#startBtn') || qs('#submitBtn');
  animateCloseModal(modalEl, returnFocus);
}

function backdropClick(e){
  if(e.target === modalBackdrop) closeModal();
}

// elements
const submitBtnEl = qs('#submitBtn');
const submitLoaderEl = qs('#submitLoader');
const responseBoxEl = qs('#response');
const textareaEl = qs('#concern-text');
const categoryEl = qs('#concern-category');
const charCountEl = qs('#charCount');

// character counter
if (textareaEl && charCountEl) {
  textareaEl.addEventListener('input', () => {
    const len = textareaEl.value.length;
    charCountEl.textContent = `${len} / ${textareaEl.getAttribute('maxlength') || 1000}`;
    // visual warning when nearing limit
    charCountEl.style.color = len > 900 ? '#ffcc66' : '';
    if (len >= (parseInt(textareaEl.getAttribute('maxlength')||1000) || 1000)) {
      charCountEl.style.color = '#ff6666';
    }
  });
}
// Submit confirmation wiring
const submitConfirmBackdrop = (() => qs('#submitConfirmBackdrop'))();
const confirmCategoryEl = () => qs('#confirmCategory');
const confirmMessageEl = () => qs('#confirmMessage');
const confirmSendBtn = () => qs('#confirmSendBtn');

function openSubmitConfirm() {
  const category = (qs('#concern-category') && qs('#concern-category').value) || '';
  const message = (qs('#concern-text') && qs('#concern-text').value) || '';

  // Basic validation before showing modal
  if (!message.trim()) {
    showResponse('Please enter a concern before submitting.', 'error');
    qs('#concern-text').focus();
    return;
  }
  if (!category) {
    showResponse('Please choose a category for this concern.', 'error');
    qs('#concern-category').focus();
    return;
  }

  // populate modal preview (escapeHtml for safety)
  if (confirmCategoryEl()) confirmCategoryEl().textContent = `Category: ${escapeHtml(category)}`;
  if (confirmMessageEl()) confirmMessageEl().textContent = message.trim();

  // show modal
  if (submitConfirmBackdrop) {
    submitConfirmBackdrop.classList.add('active');
    submitConfirmBackdrop.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    setTimeout(()=> {
      const cb = document.getElementById('confirmSendBtn');
      if(cb) cb.focus({preventScroll:true});
    }, 60);
  }

  // ensure the Confirm button sends the current form (use a delegated handler)
  if (confirmSendBtn()) {
    // remove previous handler (if any) to avoid duplicates
    confirmSendBtn().onclick = async function() {
      // close the modal first
      closeSubmitConfirm();
      // call the existing submitConcern() â€” it will read the inputs itself
      await submitConcern();
    };
  }
}

function closeSubmitConfirm() {
  // if confirm button (or any element inside modal) has focus, move focus back to submit button first
  const active = document.activeElement;
  if (active && submitConfirmBackdrop && submitConfirmBackdrop.contains(active)) {
    // move focus to submit button (or clear focus)
    const submitBtnEl = document.getElementById('submitBtn');
    if (submitBtnEl) {
      submitBtnEl.focus({preventScroll:true});
    } else {
      try { active.blur(); } catch(e) {}
    }
  }

  if (submitConfirmBackdrop) {
  // animate close instead of hiding immediately
  animateCloseModal(submitConfirmBackdrop, qs('#submitBtn'));
    submitConfirmBackdrop.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
}

// submit (updated): category required, remove token from client, optimistic UI
async function submitConcern() {
  // query the DOM at call time to avoid "not defined" errors
  const ta = qs('#concern-text');
  const submitBtnEl = qs('#submitBtn');
  const submitLoaderEl = qs('#submitLoader');
  const respEl = qs('#response');
  const categoryEl = qs('#concern-category'); // optional if you added category
  const message = ta ? String(ta.value || '').trim() : '';
  const category = categoryEl ? String(categoryEl.value || '').trim() : '';

  if (!message) {
    showResponse('Please enter a concern before submitting.', 'error');
    if (ta) ta.focus();
    return;
  }
  if (categoryEl && !category) {
    showResponse('Please choose a category for this concern.', 'error');
    categoryEl.focus();
    return;
  }

  if (submitBtnEl) submitBtnEl.disabled = true;
  if (submitLoaderEl) submitLoaderEl.style.display = 'inline-block';
  if (respEl) respEl.style.display = 'none';

  try {
    const form = new URLSearchParams();
    form.append('message', message);
    form.append('source', 'VOLUN');
    if (category) form.append('category', category);
    form.append('extra', '');

    // 10s timeout for fetch
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);

    const res = await fetch(`https://script.google.com/macros/s/${DEPLOYED_ID}/exec`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString(),
      signal: controller.signal,
      redirect: 'follow'
    });

    clearTimeout(timeoutId);

    if (!res.ok) {
      if (res.status === 401 || res.status === 403) throw new Error('Unauthorized. Server rejected the request (401/403).');
      throw new Error(`Server responded with status ${res.status}: ${res.statusText}`);
    }

    const data = await res.json().catch(() => { throw new Error('Invalid server response (not JSON).'); });

    if (!data || data.success !== true) throw new Error(data?.error || data?.message || 'Server returned an error. Please try again.');

    const catMain = (data.category && data.category.main) ? data.category.main : (category || 'Uncategorized');
    const catSub = (data.category && data.category.sub) ? data.category.sub : (data.category && data.category.sub) ? data.category.sub : 'Unknown';

    let html = `<div style="margin-bottom:10px"><strong style="color:#00ff88">âœ“ Concern Submitted Successfully!</strong></div>`;
    html += `<div class="muted" style="margin-bottom:10px">Category: <strong>${escapeHtml(catMain)}</strong> â€º <strong>${escapeHtml(catSub)}</strong></div>`;

    showResponse(html, 'success');

    // clear form fields
    if (ta) ta.value = '';
    if (categoryEl) categoryEl.value = '';
    const charCountEl = qs('#charCount');
    if (charCountEl) charCountEl.textContent = '0 / 1000';

    // refresh recommendations (non-blocking)
    fetchRecommendations().catch(err => console.error('Failed to refresh recommendations:', err));
  } catch (err) {
    console.error('Submission error:', err);
    const isAbort = err && err.name === 'AbortError';
    const friendly = isAbort ? 'Request timed out. Please try again.' : (err.message || 'An unexpected error occurred. Please try again.');
    const errorMsg = `<strong style="color:#ff4444">âœ— Submission Failed</strong><div style="margin-top:8px">${escapeHtml(friendly)}</div><div class="muted" style="margin-top:8px">If the problem persists, contact your administrator.</div>`;
    showResponse(errorMsg, 'error');
  } finally {
    if (submitBtnEl) submitBtnEl.disabled = false;
    if (submitLoaderEl) submitLoaderEl.style.display = 'none';
  }
}

/* ---------- COPY ---------- */
function copyText(text){
  const decoded = text.replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,'\\');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(decoded).catch(()=> prompt('Copy this text manually:', decoded));
  } else prompt('Copy this text:', decoded);
}

/* ---------- RECOMMENDATIONS ---------- */
const cardsContainer = qs('#cards-container'), recLoader = qs('#recLoader');
let lastFetched = [];

// 1) Patch fetchRecommendations to avoid sending client token (edit your existing function)
async function fetchRecommendations(){
  cardsContainer.innerHTML = '';
  recLoader.style.display = 'inline-block';
  try {
    // Note: this GET must match your Apps Script permissions.
    // If Apps Script requires a token, use a server-side check or POST; avoid embedding secrets in client URLs.
    const res = await fetch(`https://script.google.com/macros/s/${DEPLOYED_ID}/exec`);
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        throw new Error('Unauthorized. The server rejected the request (401/403). Check Apps Script access / token policy.');
      }
      throw new Error(`Failed to fetch: ${res.status} ${res.statusText}`);
    }
      // show skeletons while loading
  cardsContainer.innerHTML = '';
  const skeletonCount = 6;
  for (let i = 0; i < skeletonCount; i++) {
    const s = document.createElement('div');
    s.className = 'card skeleton';
    s.style.minHeight = '84px';
    s.innerHTML = `<div style="height:14px;width:36%;margin-bottom:8px;background:rgba(255,255,255,0.02);border-radius:6px"></div>
                   <div style="height:10px;width:88%;margin-bottom:6px;background:rgba(255,255,255,0.01);border-radius:6px"></div>
                   <div style="height:10px;width:72%;background:rgba(255,255,255,0.01);border-radius:6px"></div>`;
    cardsContainer.appendChild(s);
  }
    const data = await res.json();
    if(!data || data.success !== true) throw new Error(data?.error || 'Failed to fetch recommendations');
    const arr = Array.isArray(data.data) ? data.data : [];
    lastFetched = arr;
    renderCardsFromSheetArray(arr);
  } catch(err){
    console.error('Error fetching recommendations:', err);
    // Show a helpful UI message and keep the loader hidden to avoid hanging state
    cardsContainer.innerHTML = `<div class="muted" style="color:#ff4444">Error loading messages: ${escapeHtml(err.message || String(err))}</div>`;
  } finally {
    recLoader.style.display = 'none';
    // ensure any skeleton state removed when data loaded or error shown
    // (renderCardsFromSheetArray will replace container contents)
  }
}


function mapRowToItem(rowObj){
  const keys = Object.keys(rowObj || {});
  const lower = k => k.toLowerCase();
  const find = parts => keys.find(k => parts.some(p=>lower(k).includes(p)));
  const timestampKey = find(['timestamp','date','time']);
  const messageKey = find(['message','msg','concern']);
  const mainKey = find(['main','category']);
  const subKey = find(['sub','subcategory']);
  const suggestionsKey = find(['suggest','project','suggested','projects']);
  return {
    timestamp: rowObj[timestampKey] || rowObj['Timestamp'] || '',
    message: rowObj[messageKey] || rowObj['Message'] || '',
    main: rowObj[mainKey] || rowObj['Main'] || '',
    sub: rowObj[subKey] || rowObj['Sub'] || '',
    suggestionsRaw: rowObj[suggestionsKey] || rowObj['SuggestedProjects'] || ''
  };
}

/* ---------- RENDERER ---------- */
function renderCardsFromSheetArray(arr) {
  const pageSize = 12;
  const items = arr.map(mapRowToItem).sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
  if (!items || items.length === 0) {
    cardsContainer.innerHTML = '<div class="muted" style="text-align:center; margin-top:20px;"><div style="font-size:24px;">ðŸ“­</div>No messages yet. Try refreshing or submitting a new concern.</div>';
    return;
  }

  // persist state
  cardsContainer._items = items;
  cardsContainer._page = 0;

  function renderPage(page) {
    const start = page * pageSize;
    const pageItems = items.slice(start, start + pageSize);
    if (page === 0) cardsContainer.innerHTML = '';

    pageItems.forEach(item => {
      const isLong = item.message && item.message.length > 240;
      const card = document.createElement('div');
      card.className = 'card';
      // put unhighlighted text in an element we can later transform for highlighting
      card.innerHTML = `
        <div class="meta"><strong>${fmtDate(item.timestamp)}</strong> Â· <span class="muted">${escapeHtml(item.main)} â€º ${escapeHtml(item.sub)}</span></div>
        <div class="message-preview"><strong>Message:</strong>
          <div class="msg-preview" aria-label="message preview">${escapeHtml(item.message || '')}</div>
          ${isLong ? `<div style="margin-top:8px"><button class="btn ghost see-more-btn">See moreâ€¦</button></div>` : ''}
        </div>
      `;
      cardsContainer.appendChild(card);

      // See more handler
      const seeMoreBtn = card.querySelector('.see-more-btn');
      if (seeMoreBtn) {
        seeMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          openMessageModal(item, []);
        });
      }

      // fallback truncation (same approach as before)
      (function fitPreview() {
        const previewEl = card.querySelector('.msg-preview');
        if (!previewEl) return;
        const fullText = String(item.message || '');
        previewEl.setAttribute('title', fullText);
        previewEl.textContent = fullText;
        if (previewEl.scrollHeight <= previewEl.clientHeight) return;
        let lo = 0, hi = fullText.length, best = 0;
        while (lo <= hi) {
          const mid = Math.floor((lo + hi) / 2);
          previewEl.textContent = fullText.slice(0, mid) + '...';
          if (previewEl.scrollHeight <= previewEl.clientHeight) { best = mid; lo = mid + 1; }
          else hi = mid - 1;
        }
        previewEl.textContent = fullText.slice(0, best) + '...';
      })();
    });

    // Load more control
    const existingLoad = qs('#loadMoreBtnWrap');
    if (existingLoad) existingLoad.remove();
    const moreWrap = document.createElement('div');
    moreWrap.id = 'loadMoreBtnWrap';
    moreWrap.style.textAlign = 'center';
    moreWrap.style.margin = '14px 0';
    if ((start + pageSize) < items.length) {
      const moreBtn = document.createElement('button');
      moreBtn.className = 'btn ghost';
      moreBtn.textContent = 'Load more';
      moreBtn.addEventListener('click', () => {
        cardsContainer._page = (cardsContainer._page || 0) + 1;
        renderPage(cardsContainer._page);
        // after rendering more pages, re-run filter/highlight to preserve current query
        applyFilterAndHighlight();
      });
      moreWrap.appendChild(moreBtn);
    }
    cardsContainer.appendChild(moreWrap);
    // once page renders, apply current search filter/highlight to the newly added nodes
    applyFilterAndHighlight();
  }

  // initial render
  renderPage(0);
}
// 2) Provide safe stubs if showResponse or clearInput are not yet defined
window.showResponse = window.showResponse || function(html, type){
  const rb = document.getElementById('response');
  if(!rb) return;
  rb.innerHTML = html;
  rb.className = 'response';
  if(type === 'success') rb.classList.add('success');
  else if(type === 'error') rb.classList.add('error');
  rb.style.display = 'block';
  try { rb.scrollIntoView({behavior:'smooth', block:'nearest'}); } catch(e){}
};
window.clearInput = window.clearInput || function(){
  const ta = document.getElementById('concern-text');
  if(ta) ta.value = '';
  const rb = document.getElementById('response');
  if(rb){ rb.style.display = 'none'; rb.className = 'response'; }
};

// 3) Attach event listeners after DOM is ready (prevents inline onclick ReferenceError)
document.addEventListener('DOMContentLoaded', function() {
  // Remove inline onclicks if present and attach robust handlers
  const submitBtn = document.getElementById('submitBtn');
  const clearBtn = document.getElementById('clearBtn');

  if (submitBtn) {
    // remove inline onclick to avoid duplicate handlers
    submitBtn.removeAttribute('onclick');
    submitBtn.addEventListener('click', function(e){
      // prefer confirmation modal if available
      if (typeof openSubmitConfirm === 'function') return openSubmitConfirm();
      if (typeof submitConcern === 'function') return submitConcern();
    });
  }

  if (clearBtn) {
    clearBtn.removeAttribute('onclick');
    clearBtn.addEventListener('click', function(e){
      if (typeof clearInput === 'function') clearInput();
    });
  }

  // wire search clear if present
  const searchClear = document.querySelector('.search-clear');
  if (searchClear) {
    searchClear.removeAttribute('onclick');
    searchClear.addEventListener('click', function(){
      const s = document.getElementById('search');
      if (s) s.value = '';
      if (typeof filterCards === 'function') filterCards();
    });
  }

  // Finally, perform the initial fetch safely (so it doesn't run before handlers/helpers exist)
  if (typeof fetchRecommendations === 'function') {
    fetchRecommendations().catch(err=>{
      console.error('Initial fetch failed:', err);
      const cards = document.getElementById('cards-container');
      if (cards) cards.innerHTML = `<div class="muted" style="color:#ff4444">Error loading messages: ${escapeHtml(err.message || String(err))}</div>`;
    });
  }
});

/* ---------- MESSAGE MODAL ---------- */
function openMessageModal(item, projects) {
  const modalBackdrop = document.getElementById('messageModalBackdrop');
  const modalBody = document.getElementById('messageModalBody');
  modalBody.innerHTML = `
    <div style="margin-bottom:10px"><strong>${fmtDate(item.timestamp)}</strong></div>
    <div class="muted" style="margin-bottom:10px">Category: <strong>${escapeHtml(item.main)}</strong> â€º <strong>${escapeHtml(item.sub)}</strong></div>
    <div style="margin-bottom:12px"><strong>Message:</strong><pre style="white-space:pre-wrap;margin:6px 0;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.02);">${escapeHtml(item.message)}</pre></div>
  `;
  modalBackdrop.classList.add('active');
  modalBackdrop.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}
function closeMessageModal() {
  const modalEl = document.getElementById('messageModalBackdrop');
  const returnFocus = qs('#cards-container') || qs('#search') || qs('#submitBtn');
  animateCloseModal(modalEl, returnFocus);
}

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMessageModal(); });

/* ---------- SORT / FILTER ---------- */
function sortCards(){
  const order = qs('#sortOrder') ? qs('#sortOrder').value : 'newest';
  const cards = Array.from(cardsContainer.querySelectorAll('.card'));
  cards.sort((a,b)=>{
    const da = new Date(a.querySelector('.meta strong').textContent);
    const db = new Date(b.querySelector('.meta strong').textContent);
    return order==='newest' ? db - da : da - db;
  });
  cards.forEach(c=> cardsContainer.appendChild(c));
}
function applyFilterAndHighlight() {
  const searchEl = qs('#search');
  if (!searchEl) return;
  const q = searchEl.value.trim();
  const qLower = q.toLowerCase();

  // For each card, show/hide and highlight
  Array.from(cardsContainer.querySelectorAll('.card')).forEach(c => {
    // locate the message preview element
    const previewEl = c.querySelector('.msg-preview');
    const text = previewEl ? previewEl.getAttribute('title') || previewEl.textContent : c.textContent;
    if (!q) {
      // clear highlights: set the textContent back to original title (we stored it)
      if (previewEl && previewEl.getAttribute('title')) previewEl.innerHTML = escapeHtml(previewEl.getAttribute('title'));
      c.style.display = 'block';
      return;
    }

    const textLower = (text || '').toLowerCase();
    const matchIndex = textLower.indexOf(qLower);
    if (matchIndex === -1) {
      c.style.display = 'none';
      // remove any leftover highlights if previously highlighted
      if (previewEl && previewEl.getAttribute('title')) previewEl.innerHTML = escapeHtml(previewEl.getAttribute('title'));
    } else {
      c.style.display = 'block';
      // build highlighted HTML: escape parts then wrap matched substring
      const original = previewEl.getAttribute('title') || text;
      const start = original.toLowerCase().indexOf(qLower);
      if (start === -1) {
        previewEl.innerHTML = escapeHtml(original);
      } else {
        const before = escapeHtml(original.slice(0, start));
        const match = escapeHtml(original.slice(start, start + q.length));
        const after = escapeHtml(original.slice(start + q.length));
        previewEl.innerHTML = `${before}<span class="match">${match}</span>${after}`;
      }
    }
  });
}

// keep old name for event wiring compatibility
function filterCards(){ applyFilterAndHighlight(); }


/* ---------- MOBILE NAV ---------- */
document.addEventListener("DOMContentLoaded", () => {
  const hamburger = document.querySelector(".hamburger");
  const nav = document.querySelector(".nav-buttons");
  if(!hamburger || !nav) return;
  hamburger.setAttribute('aria-expanded','false');
  hamburger.addEventListener("click", (e) => {
    const expanded = nav.classList.toggle("active");
    hamburger.setAttribute('aria-expanded', String(expanded));
  });
  nav.querySelectorAll(".nav-btn").forEach(btn=> btn.addEventListener("click", ()=> {
    nav.classList.remove("active");
    hamburger.setAttribute('aria-expanded','false');
  }));
  document.addEventListener('click', (e) => {
    if (!nav.contains(e.target) && !hamburger.contains(e.target)) {
      nav.classList.remove("active");
      hamburger.setAttribute('aria-expanded','false');
    }
  });
});

function updateSubcategories(){
  const main = qs('#main-category').value; const sub = qs('#sub-category'); sub.innerHTML = '<option value="">Choose Subcategory</option>';
  if(main==='TMF') ['MF1','MF2','TF','Welding'].forEach(s=> sub.append(new Option(s,s)));
  else if(main==='EXE') ['XF','EF1','EF2'].forEach(s=> sub.append(new Option(s,s)));
  else if(main==='Kaizenset') ['Welding', 'ICT','Mechatronics'].forEach(s=> sub.append(new Option(s,s)));
  else if(main==='Other')['Cafeteria','Mass','General','Facilitation','Offsite','Anvil'].forEach(s=> sub.append(new Option(s,s)));
  qs('#suggestion-container').innerHTML='';
}

/* ---------- IDEAS SECTION ---------- */
let lastFetchedIdeas = [];

async function fetchIdeas() {
  const container = qs('#ideas-container');
  const loader = qs('#ideasLoader');
  if (!container || !loader) return;

  loader.style.display = 'block';
  container.innerHTML = ''; // Clear previous cards

  try {
    const res = await fetch(`https://script.google.com/macros/s/${DEPLOYED_ID}/exec?action=getIdeas`);
    if (!res.ok) throw new Error(`Failed to fetch ideas: ${res.status}`);

    const data = await res.json();
    if (data.success !== true) throw new Error(data.error || 'Server returned an error.');

    lastFetchedIdeas = Array.isArray(data.data) ? data.data : [];
    renderIdeaCards(lastFetchedIdeas);

  } catch (err) {
    console.error('Error fetching ideas:', err);
    container.innerHTML = `<div class="muted" style="color:#ff4444">Error loading ideas: ${escapeHtml(err.message)}</div>`;
  } finally {
    loader.style.display = 'none';
  }
}

function renderIdeaCards(ideas) {
    const container = qs('#ideas-container');
    if (!ideas || ideas.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center; margin-top:20px; width:100%;"><div style="font-size:24px;">ðŸ¤”</div>No ideas have been submitted yet.</div>';
        return;
    }

    container.innerHTML = ''; // Clear
    ideas.forEach(idea => {
        const card = document.createElement('div');
        card.className = 'dashboard-card'; // Reuse existing card style
        card.innerHTML = `
            <div class="card-body">
              <div>
                <div class="card-heading">${escapeHtml(idea.TITLE || 'No Title')}</div>
                <div class="card-sub muted">by ${escapeHtml(idea.AUTHOR || 'Anonymous')}</div>
              </div>
              <div class="card-actions">
                <button class="btn" onclick="openIdeaDetailsModal('${idea.TIMESTAMP}')">View</button>
              </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function openIdeaDetailsModal(timestamp) {
    const idea = lastFetchedIdeas.find(i => i.TIMESTAMP === timestamp);
    if (!idea) {
        alert('Could not find idea details.');
        return;
    }
    const modal = qs('#ideaDetailsModal');
    const body = qs('#ideaDetailsModalBody');
    if (!modal || !body) return;

    body.innerHTML = `
        <div style="margin-bottom:10px"><strong>Submitted:</strong> ${fmtDate(idea.TIMESTAMP)}</div>
        <div class="muted" style="margin-bottom:10px"><strong>Category:</strong> ${escapeHtml(idea['MAIN-CATEGORY'])} â€º ${escapeHtml(idea['SUB-CATEGORY'])}</div>
        <div style="margin-bottom:12px"><strong>Title:</strong><div style="padding:6px 0; font-size: 1.1em; font-weight: 500;">${escapeHtml(idea.TITLE)}</div></div>
        <div style="margin-bottom:12px"><strong>Details:</strong><pre style="white-space:pre-wrap;margin:6px 0;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.02);">${escapeHtml(idea.DETAILS)}</pre></div>
        <div class="muted"><strong>Author:</strong> ${escapeHtml(idea.AUTHOR)}</div>
    `;

    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
}

function closeIdeaDetailsModal() {
    animateCloseModal(qs('#ideaDetailsModal'));
}


/* ---------- SUGGESTION MODAL ---------- */
function handleSubcategoryChange(event) {
  const mainCategory = qs('#main-category').value;
  const subCategory = event.target.value;
  if (mainCategory && subCategory) {
    openSuggestionModal(mainCategory, subCategory);
  }
}

function openSuggestionModal(mainCategory, subCategory) {
  const modal = qs('#suggestionModal');
  if (!modal) return;

  // Reset form
  qs('#suggestionForm').reset();
  qs('#suggestionResponse').style.display = 'none';

  // Populate categories
  const mainSelect = qs('#suggestion-main-category');
  const subSelect = qs('#suggestion-sub-category');

  // Populate and set main category
  mainSelect.innerHTML = qs('#main-category').innerHTML;
  mainSelect.value = mainCategory;

  // Logic to populate sub-categories based on main
  const populateSubs = (mainCatValue) => {
      subSelect.innerHTML = '<option value="">Choose Subcategory</option>';
      const tempSubOptions = {
          'TMF': ['MF1','MF2','TF','Welding'],
          'EXE': ['XF','EF1','EF2'],
          'Kaizenset': ['Welding', 'ICT','Mechatronics'],
          'Other': ['Cafeteria','Mass','General','Facilitation','Offsite','Anvil']
      };
      if (tempSubOptions[mainCatValue]) {
          tempSubOptions[mainCatValue].forEach(s => subSelect.append(new Option(s, s)));
      }
  };

  populateSubs(mainCategory);
  subSelect.value = subCategory;

  // Update subcategories if main is changed inside the modal
  mainSelect.onchange = () => populateSubs(mainSelect.value);

  modal.classList.add('active');
  modal.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';

  // Wire up the send button to prevent multiple submissions
  qs('#suggestionSendBtn').onclick = () => {
      qs('#suggestionSendBtn').disabled = true;
      submitSuggestion();
  };
}

function closeSuggestionModal() {
  const modal = qs('#suggestionModal');
  if (modal) {
    animateCloseModal(modal, qs('#sub-category'));
    // Reset the main page dropdowns so user can re-select
    qs('#main-category').value = '';
    qs('#sub-category').innerHTML = '<option value="">Choose Subcategory</option>';
  }
}

async function submitSuggestion() {
  const loader = qs('#suggestionLoader');
  const responseEl = qs('#suggestionResponse');
  const sendBtn = qs('#suggestionSendBtn');

  const payload = {
    action: 'submitSuggestion',
    title: qs('#suggestion-title').value.trim(),
    details: qs('#suggestion-details').value.trim(),
    mainCategory: qs('#suggestion-main-category').value,
    subCategory: qs('#suggestion-sub-category').value,
    author: qs('#suggestion-author').value.trim() || 'Anonymous'
  };

  // Validation
  if (!payload.title || !payload.details || !payload.mainCategory || !payload.subCategory) {
    showSuggestionResponse('Title, Details, and Categories are required.', 'error');
    sendBtn.disabled = false; // re-enable button
    return;
  }

  loader.style.display = 'block';
  responseEl.style.display = 'none';

  try {
    const res = await fetch(`https://script.google.com/macros/s/${DEPLOYED_ID}/exec`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams(payload).toString(),
      redirect: 'follow'
    });

    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    const data = await res.json();
    if (data.success !== true) throw new Error(data.error || 'Submission failed.');

    showSuggestionResponse('âœ“ Suggestion submitted successfully!', 'success');
    setTimeout(closeSuggestionModal, 1500);

  } catch (err) {
    console.error("Suggestion submission error:", err);
    showSuggestionResponse(`âœ— Error: ${err.message}`, 'error');
  } finally {
    loader.style.display = 'none';
    sendBtn.disabled = false;
  }
}

function showSuggestionResponse(html, type) {
    const responseEl = qs('#suggestionResponse');
    if (!responseEl) return;
    responseEl.innerHTML = html;
    responseEl.className = 'response'; // reset classes
    if (type === 'success') responseEl.classList.add('success');
    if (type === 'error') responseEl.classList.add('error');
    responseEl.style.display = 'block';
}

/* ---------- INITIAL ---------- */
(async function init(){
  showSection('submit');
  fetchRecommendations().catch(err=> console.error('Initial fetch failed:', err));
})();
</script>
</body>
</html>
<!--    END CREDITS:
        Â© Joshua M. Narvasa 
        Â© Freki
        Â© narvasajoshua61@gmail.com

        IDEA BY:
        Â© Kaiser
-->
